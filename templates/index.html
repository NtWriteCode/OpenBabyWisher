{% extends "base.html" %}

{% block title %}{{ super() }} - Wishlist{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="text-center mb-12 animate-fade-in">
    <div class="glass-effect p-8 mb-8 max-w-4xl mx-auto">
        <h2 id="welcome-message" class="text-2xl font-semibold text-white/90 mb-2 animate-slide-up">Welcome to Our Baby Wishlist!</h2>
        <h1 class="text-5xl font-bold text-white mb-4 animate-slide-up" data-i18n="title">Baby Wishlist</h1>
        <p class="text-xl text-white/80 mb-6 animate-slide-up" style="animation-delay: 0.1s" data-i18n="subtitle">{hero_message}</p>
        
        <!-- Quick Stats -->
        <div class="flex justify-center items-center gap-8 text-white/70 text-sm">
            <div class="flex items-center gap-2">
                <i class="fas fa-gift"></i>
                <span id="total-items">0</span>
                <span data-i18n="items">items</span>
            </div>
            <div class="flex items-center gap-2">
                <i class="fas fa-check-circle"></i>
                <span id="completed-items">0</span>
                <span data-i18n="completed">completed</span>
            </div>
            <div class="flex items-center gap-2">
                <i class="fas fa-heart"></i>
                <span id="hints-count">0</span>
                <span data-i18n="hints">hints received</span>
            </div>
        </div>
    </div>
    
    <!-- Admin Link (Floating) -->
    <a href="/admin" class="admin-floating-btn group" title="Admin Panel">
        <i class="fas fa-user-shield"></i>
        <div class="admin-tooltip">
            <span data-i18n="adminPanel">Admin Panel</span>
        </div>
    </a>
</div>

<!-- Loading State -->
<div id="loading-state" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    <!-- Loading skeletons will be inserted here -->
</div>

<!-- Empty State -->
<div id="empty-state" class="text-center py-20" style="display: none;">
    <div class="glass-card p-12 max-w-md mx-auto">
        <div class="text-6xl mb-6 animate-bounce-gentle">🍼</div>
        <h3 class="text-2xl font-semibold text-gray-700 mb-4" data-i18n="noItems">No items yet</h3>
        <p class="text-gray-500 mb-6" data-i18n="noItemsDesc">The wishlist is being prepared with love</p>
        <div class="animate-pulse-soft">
            <i class="fas fa-heart text-pink-400 text-2xl"></i>
        </div>
    </div>
</div>

<!-- Wishlist Grid -->
<div id="wishlist-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" style="display: none;">
    <!-- Items will be loaded here -->
</div>

<!-- Purchase Hint Modal -->
<div id="hint-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" style="display: none;">
    <div class="modal-modern p-8 max-w-lg w-full mx-4 animate-slide-up">
        <div class="text-center mb-6">
            <div class="text-4xl mb-4">💝</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2" data-i18n="addHint">I've got this!</h3>
            <p class="text-gray-600" data-i18n="hintDescription">Let others know you're planning to get this gift</p>
        </div>
        
        <!-- Quick Messages -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-3" data-i18n="quickMessages">Quick Messages</label>
            <div id="quick-messages" class="grid grid-cols-1 gap-2">
                <!-- Quick message buttons will be inserted here -->
            </div>
        </div>
        
        <div class="flex items-center gap-4 mb-6">
            <hr class="flex-1 border-gray-300">
            <span class="text-gray-500 text-sm font-medium" data-i18n="or">OR</span>
            <hr class="flex-1 border-gray-300">
        </div>
        
        <!-- Custom Message -->
        <div class="mb-8">
            <label class="block text-sm font-semibold text-gray-700 mb-3" data-i18n="customMessage">Custom Message</label>
            <textarea id="custom-message" class="input-modern w-full h-24 resize-none" 
                      data-i18n="hintPlaceholder" placeholder="Add your personal note..."></textarea>
        </div>
        
        <!-- Actions -->
        <div class="flex gap-3">
            <button id="send-hint-btn" class="btn-modern flex-1 flex items-center justify-center gap-2">
                <i class="fas fa-paper-plane"></i>
                <span data-i18n="sendHint">Send Hint</span>
            </button>
            <button onclick="closeHintModal()" class="btn-outline-modern px-6">
                <span data-i18n="cancel">Cancel</span>
            </button>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div id="image-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50" style="display: none;">
    <div class="max-w-4xl max-h-full p-4 w-full">
        <div class="relative">
            <img id="modal-image" class="w-full h-auto max-h-[80vh] object-contain rounded-2xl">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 w-12 h-12 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="text-center mt-4">
            <p id="modal-image-name" class="text-white/80"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let wishlistItems = [];
let predefinedMessages = {};
let currentHintItemId = null;

// Enhanced translations
const wishlistTranslations = {
    en: {
        ...translations.en,
        items: "items",
        highPriority: "high priority", 
        hints: "hints received",
        noItems: "No items yet",
        noItemsDesc: "The wishlist is being prepared with love",
        quickMessages: "Quick Messages",
        or: "OR",
        customMessage: "Custom Message",
        hintDescription: "Let others know you're planning to get this gift",
        cancel: "Cancel",
        priority: "Priority",
        available: "Available",
        claimed: "Someone's got this!",
        completed: "Completed",
        viewImage: "View Image",
        sendingHint: "Sending hint...",
        hintSent: "Hint sent successfully! 🎉",
        errorSending: "Failed to send hint",
        selectOrType: "Select a quick message or type your own"
    },
    hu: {
        ...translations.hu,
        items: "elem",
        highPriority: "magas prioritás",
        hints: "jelzés érkezett", 
        noItems: "Még nincsenek elemek",
        noItemsDesc: "A kívánságlistát szeretettel készítjük",
        quickMessages: "Gyors Üzenetek",
        or: "VAGY",
        customMessage: "Egyéni Üzenet",
        hintDescription: "Tudasd másokkal, hogy tervezed megvenni ezt az ajándékot",
        cancel: "Mégse",
        priority: "Prioritás",
        available: "Elérhető",
        claimed: "Valaki már gondoskodik róla!",
        completed: "Befejezve",
        viewImage: "Kép Megtekintése",
        sendingHint: "Jelzés küldése...",
        hintSent: "Jelzés sikeresen elküldve! 🎉",
        errorSending: "Jelzés küldése sikertelen",
        selectOrType: "Válassz egy gyors üzenetet vagy írj sajátot"
    }
};

// Merge translations
Object.assign(translations.en, wishlistTranslations.en);
Object.assign(translations.hu, wishlistTranslations.hu);

async function loadWishlist() {
    const container = document.getElementById('wishlist-grid');
    const loading = document.getElementById('loading-state');
    const empty = document.getElementById('empty-state');
    
    // Show loading skeleton
    loading.innerHTML = createLoadingSkeleton(6);
    loading.style.display = 'grid';
    
    try {
        const [itemsResponse, messagesResponse] = await Promise.all([
            fetch('/api/items'),
            fetch('/api/predefined-messages')
        ]);
        
        wishlistItems = await itemsResponse.json();
        predefinedMessages = await messagesResponse.json();
        
        updateStats();
        renderWishlist();
        
    } catch (error) {
        console.error('Error loading wishlist:', error);
        showToast(t('error'), 'error');
    } finally {
        loading.style.display = 'none';
    }
}

function updateStats() {
    const totalItems = wishlistItems.length;
    const completedItems = wishlistItems.filter(item => item.disabled).length;
    const totalHints = wishlistItems.reduce((sum, item) => sum + item.hints.length, 0);
    
    document.getElementById('total-items').textContent = totalItems;
    document.getElementById('completed-items').textContent = completedItems;
    document.getElementById('hints-count').textContent = totalHints;
}

function renderWishlist() {
    const container = document.getElementById('wishlist-grid');
    const empty = document.getElementById('empty-state');
    
    if (wishlistItems.length === 0) {
        empty.style.display = 'block';
        container.style.display = 'none';
        return;
    }
    
    empty.style.display = 'none';
    container.style.display = 'grid';
    
    container.innerHTML = wishlistItems.map((item, index) => {
        const hasHints = item.hints.length > 0;
        
        return `
            <div class="wishlist-card ${item.disabled ? 'card-disabled' : ''}" 
                 onclick="openItemModal(${item.id})"
                 style="animation: slide-up 0.5s ease-out ${index * 0.1}s both">
                
                <!-- Header -->
                <div class="card-header">
                    <h3 class="card-title">${escapeHtml(item.title)}</h3>
                    <div class="card-status ${item.disabled ? 'status-completed' : hasHints ? 'status-claimed' : 'status-available'}">
                        ${item.disabled ? t('completed') : hasHints ? t('claimed') : t('available')}
                    </div>
                </div>
                
                <!-- Description -->
                ${item.description ? `
                    <div class="card-description" id="desc-${item.id}">
                        ${item.description}
                        <div class="card-description-fade"></div>
                    </div>
                    <div class="description-toggle" onclick="event.stopPropagation(); toggleDescription(${item.id})">
                        <span id="toggle-text-${item.id}">${t('readMore') || 'Read more'}</span>
                        <i class="fas fa-chevron-down" id="toggle-icon-${item.id}"></i>
                    </div>
                ` : ''}
                
                <!-- Tags -->
                ${item.tags.length > 0 ? `
                    <div class="card-tags">
                        ${item.tags.map(tag => `
                            <span class="tag-item">${escapeHtml(tag)}</span>
                        `).join('')}
                    </div>
                ` : ''}
                
                <!-- Images -->
                ${item.images.length > 0 ? `
                    <div class="card-images">
                        <div class="card-images-preview">
                            ${item.images.slice(0, 6).map((img, imgIndex) => `
                                <div class="card-image" onclick="event.stopPropagation(); openImageModal('${img.url}', '${escapeHtml(img.original_filename)}')">
                                    <img src="${img.url}" alt="${escapeHtml(img.original_filename)}">
                                    ${imgIndex === 5 && item.images.length > 6 ? `
                                        <div class="card-image-count">+${item.images.length - 6}</div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Hints Display -->
                ${hasHints ? `
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-4">
                        <div class="flex items-center gap-2 text-amber-700">
                            <i class="fas fa-gift"></i>
                            <span class="font-medium text-sm">${personalizedTexts.hint_message || t('someoneGotThis')}</span>
                            <span class="text-xs bg-amber-200 px-2 py-1 rounded-full">${item.hints.length}</span>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Action Button -->
                ${!item.disabled ? `
                    <div class="card-actions">
                        <button onclick="event.stopPropagation(); openHintModal(${item.id})" class="card-action-btn">
                            <i class="fas fa-gift"></i>
                            ${t('iGotThis')}
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
    
    // Apply tag colors after rendering
    setTimeout(() => {
        applyTagColors();
    }, 10);
}

function openItemModal(itemId) {
    const item = wishlistItems.find(i => i.id === itemId);
    if (!item) return;
    
    // Create or update item detail modal
    let modal = document.getElementById('item-detail-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'item-detail-modal';
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4';
        modal.style.display = 'none';
        document.body.appendChild(modal);
    }
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <!-- Header -->
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">${escapeHtml(item.title)}</h2>
                        <div class="flex items-center gap-3">
                            ${item.disabled ? 
                                `<span class="px-3 py-1 bg-gray-500 text-white text-sm font-semibold rounded-full">${t('completed')}</span>` :
                                `<span class="px-3 py-1 bg-green-500 text-white text-sm font-semibold rounded-full">${t('available')}</span>`
                            }
                        </div>
                    </div>
                    <button onclick="closeItemModal()" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
                
                <!-- Description -->
                ${item.description ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">${t('description') || 'Description'}</h3>
                        <div class="prose prose-lg max-w-none text-gray-600">${item.description}</div>
                    </div>
                ` : ''}
                
                <!-- Tags -->
                ${item.tags.length > 0 ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">${t('tags') || 'Tags'}</h3>
                        <div class="tag-cloud">
                            ${item.tags.map(tag => `<span class="tag-item">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Images -->
                ${item.images.length > 0 ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">${t('images') || 'Images'} (${item.images.length})</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            ${item.images.map(img => `
                                <img src="${img.url}" 
                                     alt="${escapeHtml(img.original_filename)}"
                                     onclick="openImageModal('${img.url}', '${escapeHtml(img.original_filename)}')"
                                     class="w-full h-32 object-cover rounded-lg cursor-pointer hover:scale-105 transition-transform">
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Action Button -->
                ${!item.disabled ? `
                    <div class="text-center">
                        <button onclick="closeItemModal(); openHintModal(${item.id})" class="btn-modern">
                            <i class="fas fa-gift mr-2"></i>
                            ${t('iGotThis') || "I've got this!"}
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeItemModal() {
    const modal = document.getElementById('item-detail-modal');
    if (modal) {
        modal.style.display = 'none';
    }
    document.body.style.overflow = 'auto';
}

function toggleDescription(itemId) {
    const descElement = document.getElementById(`desc-${itemId}`);
    const toggleText = document.getElementById(`toggle-text-${itemId}`);
    const toggleIcon = document.getElementById(`toggle-icon-${itemId}`);
    
    if (descElement.classList.contains('expanded')) {
        // Collapse
        descElement.classList.remove('expanded');
        toggleText.textContent = t('readMore') || 'Read more';
        toggleIcon.className = 'fas fa-chevron-down';
    } else {
        // Expand
        descElement.classList.add('expanded');
        toggleText.textContent = t('readLess') || 'Read less';
        toggleIcon.className = 'fas fa-chevron-up';
    }
}

function openHintModal(itemId) {
    currentHintItemId = itemId;
    const modal = document.getElementById('hint-modal');
    const quickMessagesContainer = document.getElementById('quick-messages');
    
    // Clear previous state
    document.getElementById('custom-message').value = '';
    
    // Populate quick messages
    const messages = predefinedMessages[currentLang] || predefinedMessages.en || [];
    quickMessagesContainer.innerHTML = messages.map(msg => `
        <button onclick="selectQuickMessage('${escapeHtml(msg)}')" 
                class="quick-message-btn p-3 text-left border-2 border-gray-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-all">
            ${escapeHtml(msg)}
        </button>
    `).join('');
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeHintModal() {
    const modal = document.getElementById('hint-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    currentHintItemId = null;
    
    // Clear selected state
    document.querySelectorAll('.quick-message-btn').forEach(btn => {
        btn.classList.remove('border-purple-400', 'bg-purple-50');
    });
}

function selectQuickMessage(message) {
    // Update UI to show selection
    document.querySelectorAll('.quick-message-btn').forEach(btn => {
        btn.classList.remove('border-purple-400', 'bg-purple-50');
    });
    
    event.target.classList.add('border-purple-400', 'bg-purple-50');
    
    // Clear custom message when quick message is selected
    document.getElementById('custom-message').value = '';
}

function openImageModal(url, filename) {
    const modal = document.getElementById('image-modal');
    const img = document.getElementById('modal-image');
    const name = document.getElementById('modal-image-name');
    
    img.src = url;
    name.textContent = filename;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    const modal = document.getElementById('image-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

async function sendHint() {
    const selectedQuickBtn = document.querySelector('.quick-message-btn.border-purple-400');
    const customMessage = document.getElementById('custom-message').value.trim();
    
    let message = '';
    if (selectedQuickBtn) {
        message = selectedQuickBtn.textContent.trim();
    } else if (customMessage) {
        message = customMessage;
    }
    
    if (!message) {
        showToast(t('selectOrType'), 'warning');
        return;
    }
    
    const sendBtn = document.getElementById('send-hint-btn');
    const originalText = sendBtn.innerHTML;
    
    // Show loading state
    sendBtn.innerHTML = `
        <i class="fas fa-spinner fa-spin"></i>
        <span>${t('sendingHint')}</span>
    `;
    sendBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/items/${currentHintItemId}/hint`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        });
        
        if (response.ok) {
            showToast(t('hintSent'), 'success');
            closeHintModal();
            loadWishlist(); // Reload to show the new hint
        } else {
            throw new Error('Failed to send hint');
        }
    } catch (error) {
        console.error('Error sending hint:', error);
        showToast(t('errorSending'), 'error');
    } finally {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
    }
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Override updateUI to also update wishlist
const originalUpdateUI = window.updateUI;
window.updateUI = function() {
    originalUpdateUI();
    if (wishlistItems.length > 0) {
        renderWishlist();
    }
};

// Event listeners
document.getElementById('send-hint-btn').addEventListener('click', sendHint);

// Close modals on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeHintModal();
        closeImageModal();
    }
});

// Load wishlist on page load
document.addEventListener('DOMContentLoaded', function() {
    loadWishlist();
    loadHeroMessage(); // Load hero message on page load
    loadPersonalizedTexts(); // Load personalized texts on page load
    loadDynamicFavicon(); // Load dynamic favicon on page load
});
</script>
{% endblock %}